# Fallen Tweaks â€” Project Plan

A Chrome extension for advanced Fallen London players, providing toggleable UI tweaks to improve gameplay.

---

## Guiding Principles

- **Respect the game staff**: All UI additions must be visually distinct from the native game UI, clearly identifiable as extension-provided (green theme, candle icon branding).
- **Modular**: Each feature lives in its own file, can be toggled independently, and is fully disabled (no DOM observers, no event listeners, no injected elements) when turned off.
- **Performant**: Features only activate on relevant pages/contexts. MutationObservers are scoped tightly. No polling.
- **Maintainable**: Adding a new feature should be as simple as creating a new module file and registering it in a manifest.
- **Polished**: Every UI element, animation, and interaction should feel considered and refined. No placeholder quality â€” each piece ships as if it's the final version.

---

## Tech Stack

| Concern | Choice | Rationale |
|---|---|---|
| Language | **TypeScript** | Type safety, better IDE support, catches bugs early |
| Bundler | **Vite** + `@crxjs/vite-plugin` | Fast builds, HMR during development, handles manifest generation |
| CSS | **Vanilla CSS** with a shared utility stylesheet | Keeps it simple; scoped via a `.ft-` prefix to avoid clashing with the game's styles |
| Popup UI | **Vanilla TS/HTML** | The popup is small enough that a framework adds no value |
| Options page UI | **Preact** | Lightweight (~3KB), JSX ergonomics for the slightly more complex settings page |
| Testing | **Vitest** for unit/logic tests | Same ecosystem as Vite, fast, good TS support |
| Task runner | **just** (justfile) | Requested; simple command aliases for build/dev/test/package |
| Package manager | **pnpm** | Fast, disk-efficient |

---

## Extension Architecture

```
fallentweaks/
â”œâ”€â”€ justfile
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ manifest.ts              # Chrome MV3 manifest (generated by crxjs)
â”‚   â”œâ”€â”€ content/
â”‚   â”‚   â”œâ”€â”€ index.ts             # Content script entry â€” loads module manager
â”‚   â”‚   â”œâ”€â”€ module-manager.ts    # Registers, enables/disables feature modules
â”‚   â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”‚   â””â”€â”€ fallen-tweaks.css  # Shared styles (.ft-* prefix)
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â”œâ”€â”€ types.ts         # FeatureModule interface
â”‚   â”‚       â”œâ”€â”€ bazaar-total.ts
â”‚   â”‚       â”œâ”€â”€ card-favourites.ts
â”‚   â”‚       â””â”€â”€ quality-favourites.ts
â”‚   â”œâ”€â”€ background/
â”‚   â”‚   â””â”€â”€ service-worker.ts    # Handles storage events, badge updates
â”‚   â”œâ”€â”€ popup/
â”‚   â”‚   â”œâ”€â”€ popup.html
â”‚   â”‚   â”œâ”€â”€ popup.ts
â”‚   â”‚   â””â”€â”€ popup.css
â”‚   â”œâ”€â”€ options/
â”‚   â”‚   â”œâ”€â”€ options.html
â”‚   â”‚   â”œâ”€â”€ options.tsx          # Preact options page
â”‚   â”‚   â””â”€â”€ options.css
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ storage.ts           # Typed wrapper around chrome.storage.sync
â”‚   â”‚   â””â”€â”€ constants.ts         # Extension name, version, module registry
â”‚   â””â”€â”€ assets/
â”‚       â”œâ”€â”€ icon-16.png
â”‚       â”œâ”€â”€ icon-48.png
â”‚       â”œâ”€â”€ icon-128.png
â”‚       â””â”€â”€ candle-green.svg     # The green candle branding icon (placeholder: ğŸ•¯ï¸ emoji for now)
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ preact-guide.md          # Preact primer for maintenance
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ bazaar-total.test.ts
â”‚   â”‚   â”œâ”€â”€ card-favourites.test.ts
â”‚   â”‚   â””â”€â”€ quality-favourites.test.ts
â”‚   â””â”€â”€ shared/
â”‚       â””â”€â”€ storage.test.ts
â””â”€â”€ dist/                        # Build output (gitignored)
```

---

## Feature Module Interface

Every feature module implements a common interface:

```ts
interface FeatureModule {
  id: string;            // Unique key, e.g. "bazaar-total"
  name: string;          // Display name, e.g. "Bazaar Total Value"
  description: string;   // One-liner for the options page
  enable(): void;        // Set up observers, inject UI
  disable(): void;       // Tear down everything â€” full cleanup
}
```

The **module manager** (`module-manager.ts`):
1. On content script load, reads enabled/disabled state from `chrome.storage.sync`.
2. Calls `enable()` only for active modules.
3. Listens for storage changes (user toggling in popup/options) and calls `enable()`/`disable()` in real time â€” no page reload needed.

---

## Module Lifecycle

```
User toggles module ON (popup/options)
  â†’ chrome.storage.sync updated
  â†’ storage.onChanged fires in content script
  â†’ module-manager calls module.enable()
    â†’ module sets up MutationObserver / event listeners
    â†’ module injects UI elements (with .ft-* classes and green candle branding)

User toggles module OFF
  â†’ chrome.storage.sync updated
  â†’ storage.onChanged fires in content script
  â†’ module-manager calls module.disable()
    â†’ module disconnects MutationObserver
    â†’ module removes all event listeners
    â†’ module removes all injected DOM elements
```

---

## Planned Feature Modules

### 1. Bazaar Total Value (`bazaar-total`)
- **Trigger**: User is on the bazaar sell page
- **Behaviour**: Reads item quantities and values from the DOM, computes total, displays a small floating summary (green-themed, candle icon)
- **Cleanup**: Remove the floating summary element

### 2. Opportunity Card Favourites (`card-favourites`)
- **Trigger**: User hovers over an opportunity deck card
- **Behaviour**: Shows an overlay (top-right of card) with star/skull icons to mark as favourite or avoid. Persists choices to storage. Favourite cards get a subtle green border; avoided cards get a dimmed appearance
- **DOM selector**: Cards identified by `.hand__card` class
- **Storage**: `{ [cardId]: "favourite" | "avoid" | null }`
- **Cleanup**: Remove overlays, remove card styling

### 3. Quality Favourites (`quality-favourites`)
- **Trigger**: User views their qualities/possessions page
- **Behaviour**: Allows marking qualities as favourites (click a star icon). Favourited qualities are moved to the top of their category list with a subtle green highlight
- **Storage**: `{ favouriteQualities: string[] }`
- **Cleanup**: Restore original sort order, remove highlight styling, remove star icons

---

## Visual Identity

- **Colour**: Green accent (`#4a9e4a` or similar â€” to be refined)
- **Branding**: Candle emoji (ğŸ•¯ï¸) used as branding icon in overlays (to be replaced with a custom green candle SVG later)
- **CSS prefix**: All injected classes use `.ft-` prefix (e.g. `.ft-overlay`, `.ft-total-badge`)
- **Attribution**: A subtle "Fallen Tweaks" text label or tooltip near injected elements, so it's clear these aren't native game features

---

## Popup (Browser Action)

A compact popup when clicking the extension icon:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ•¯ï¸ Fallen Tweaks        â”‚  (header with green candle icon)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Bazaar Total      [ON]  â”‚
â”‚  Card Favourites   [OFF] â”‚
â”‚  Quality Favs      [ON]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              âš™ï¸ Settings  â”‚  (opens options page in new tab)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Toggles update `chrome.storage.sync` immediately
- Simple vanilla HTML/TS, no framework needed

---

## Options Page

Full settings page opened in a new tab:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ•¯ï¸ Fallen Tweaks                    v0.1.0  â”‚  (header)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€ Bazaar Total Value â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [ON] â”€â”  â”‚
â”‚  â”‚ Shows the total value of items when     â”‚  â”‚
â”‚  â”‚ selling at the Bazaar.                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€ Opportunity Card Favourites â”€â”€â”€ [OFF] â”  â”‚
â”‚  â”‚ Mark opportunity cards as favourites or  â”‚  â”‚
â”‚  â”‚ ones to avoid. Favourites are            â”‚  â”‚
â”‚  â”‚ highlighted; avoided cards are dimmed.   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  ... more modules ...                        â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Fallen Tweaks Â· Not affiliated with FBG    â”‚  (footer)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Built with Preact for slightly richer interactivity
- Reads module list from a central registry (no hardcoded UI per module)
- Green-themed, dark-friendly

---

## Justfile

```just
default:
    @just --list

# Install dependencies
setup:
    pnpm install

# Start dev server with HMR
dev:
    pnpm vite

# Build for production
build:
    pnpm vite build

# Package into .zip for Chrome Web Store / distribution
package: build
    cd dist && zip -r ../fallen-tweaks.zip .

# Run tests
test:
    pnpm vitest run

# Run tests in watch mode
test-watch:
    pnpm vitest

# Type check
check:
    pnpm tsc --noEmit

# Lint
lint:
    pnpm eslint src/

# Format code
format:
    pnpm prettier --write src/

# Check formatting (CI-friendly)
format-check:
    pnpm prettier --check src/
```

---

## Testing Strategy

### What we can test with Vitest (unit tests)

- **Module logic**: Pure functions like "given these DOM quantities/prices, compute the total" â€” extract the calculation logic out of DOM interaction and test it directly
- **Storage helpers**: Mock `chrome.storage` API and test read/write/toggle logic
- **Module manager**: Test that enable/disable calls happen correctly in response to storage changes

### Out of scope for unit tests

- Actual DOM injection into the Fallen London page (needs the real page structure)
- MutationObserver behaviour against live DOM changes

These will be verified manually during development.

---

## Implementation Phases

### Phase 1 â€” Scaffold
- Project setup (Vite, TS, pnpm, justfile)
- Manifest v3 configuration
- Content script entry point + module manager
- Shared storage utilities
- Popup (with placeholder toggle list)
- Options page (with placeholder module cards)
- Branding (candle emoji placeholder)
- Preact guide in `docs/`
- Vitest setup with chrome API mocks

### Phase 2 â€” First Module (Bazaar Total)
- Implement `bazaar-total` module
- Shared CSS for extension overlays
- End-to-end toggle flow (popup â†’ storage â†’ content script â†’ enable/disable)
- Tests for calculation logic

### Phase 3 â€” Card Favourites Module
- Implement `card-favourites` module
- Hover overlay UI
- Favourite/avoid persistence
- Card visual styling

### Phase 4 â€” Quality Favourites Module
- Implement `quality-favourites` module
- Star icon UI
- Sort reordering logic
- Favourite persistence

### Phase 5 â€” Polish & Distribution
- Refine visual design
- Chrome Web Store assets (screenshots, description)
- Package and publish

---

## Resolved Decisions

| Decision | Resolution |
|---|---|
| Game DOM stability | Stable enough â€” HTML fragments will be supplied per-feature as needed |
| Options page framework | Preact, with a maintenance guide in `docs/` |
| Green shade | `#4a9e4a` as starting point, iterate as we go |
| Candle asset | Candle emoji (ğŸ•¯ï¸) placeholder until a custom SVG is created |
| Card identification | `.hand__card` CSS class |
| Storage | `chrome.storage.sync` â€” efficient, cross-device |
| Permission scope | `https://www.fallenlondon.com/*` only |
| Browser support | Chrome only (Firefox port planned later, not in scope) |
| Code style | ESLint (`@typescript-eslint/recommended`) + Prettier, with a format check command |
